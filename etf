import pandas as pd
import requests
import io
from datetime import datetime, timedelta

# 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
def get_pdf_data(date_str):
    url = f"https://timeetf.co.kr/pdf_excel.php?idx=2&cate=&pdfDate={date_str}"
    headers = {'User-Agent': 'Mozilla/5.0'}

    try:
        res = requests.get(url, headers=headers)
        if res.status_code == 200 and len(res.content) > 1000:
            df = pd.read_excel(io.BytesIO(res.content))
            return df
        else:
            return None
    except:
        return None

# 2. ë‚ ì§œ ì„¤ì •
today_str = datetime.now().strftime('%Y-%m-%d')
yesterday_str = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')

print(f"ğŸš€ TIME ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100 ì•¡í‹°ë¸Œ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ({today_str})\n")

# 3. ë°ì´í„° ì‹¤í–‰
df_today = get_pdf_data(today_str)
df_yesterday = get_pdf_data(yesterday_str)

if df_today is not None and df_yesterday is not None:
    col_name = 'ë¹„ì¤‘(%)' if 'ë¹„ì¤‘(%)' in df_today.columns else 'ë¹„ì¤‘'

    today_sub = df_today[['ì¢…ëª©ëª…', col_name]].rename(columns={col_name: 'ì˜¤ëŠ˜(%)'})
    yesterday_sub = df_yesterday[['ì¢…ëª©ëª…', col_name]].rename(columns={col_name: 'ì–´ì œ(%)'})

    # ë°ì´í„° ë³‘í•©
    merged = pd.merge(today_sub, yesterday_sub, on='ì¢…ëª©ëª…', how='outer').fillna(0)
    merged['ì¦ê°(P)'] = merged['ì˜¤ëŠ˜(%)'] - merged['ì–´ì œ(%)']

    # [ìˆ˜ì •] ì˜¤ëŠ˜ ë¹„ì¤‘ì´ ë†’ì€ ìˆœì„œëŒ€ë¡œ ì •ë ¬
    result = merged.sort_values(by='ì˜¤ëŠ˜(%)', ascending=False).round(2)

    # 4. ê²°ê³¼ ì¶œë ¥
    print(f"âœ… í˜„ì¬ ë¹„ì¤‘ì´ ë†’ì€ ìˆœì„œëŒ€ë¡œ ì •ë ¬ëœ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.")
    display(result)

else:
    print("âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¥ ì‹œì‘ ì „ì´ê±°ë‚˜ ë‚ ì§œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
